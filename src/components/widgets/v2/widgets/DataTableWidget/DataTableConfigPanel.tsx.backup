/**
 * Data Table Widget Configuration Panel
 * Allows users to add/edit multiple tables with custom columns
 */

import { useState } from 'react';
import {
  Button,
  Form,
  Input,
  Select,
  Switch,
  Collapse,
  Space,
  InputNumber,
  Popconfirm,
  Empty,
  Tag,
  Table as AntTable,
} from 'antd';
import {
  PlusOutlined,
  DeleteOutlined,
  TableOutlined,
  LinkOutlined,
} from '@ant-design/icons';
import type { DataTableWidgetConfig, TableElementConfig, TableColumnConfig } from '../../types/ConfigurableWidget.types';
import { getDataSourcesByType } from '../../data/mockDataSources';
import '../../base/ConfigurableWidget.css';

const { Panel } = Collapse;

interface DataTableConfigPanelProps {
  config: DataTableWidgetConfig;
  onChange: (newConfig: DataTableWidgetConfig) => void;
  onClose: () => void;
}

const RENDER_TYPES = [
  { label: 'Text', value: 'text' },
  { label: 'Badge', value: 'badge' },
  { label: 'Progress', value: 'progress' },
  { label: 'Date', value: 'date' },
  { label: 'Number', value: 'number' },
  { label: 'Boolean', value: 'boolean' },
];

export default function DataTableConfigPanel({ config, onChange, onClose }: DataTableConfigPanelProps) {
  const [activeKey, setActiveKey] = useState<string[]>([]);

  const tableDataSources = [
    ...getDataSourcesByType('static-data'),
    ...getDataSourcesByType('alert-stream'),
  ];

  const handleAddTable = () => {
    const newTable: TableElementConfig = {
      id: `table-${Date.now()}`,
      name: `Table ${config.elements.length + 1}`,
      enabled: true,
      displayOrder: config.elements.length,
      type: 'table',
      columns: [
        { id: 'col-1', name: 'ID', dataKey: 'id', sortable: true, filterable: false, render: 'text', width: 100 },
        { id: 'col-2', name: 'Name', dataKey: 'name', sortable: true, filterable: true, render: 'text' },
        { id: 'col-3', name: 'Status', dataKey: 'status', sortable: true, filterable: true, render: 'badge' },
      ],
      pageSize: 10,
      showPagination: true,
      showSearch: true,
      exportable: true,
    };

    onChange({
      ...config,
      elements: [...config.elements, newTable],
    });
    setActiveKey([...activeKey, newTable.id]);
  };

  const handleDeleteTable = (tableId: string) => {
    onChange({
      ...config,
      elements: config.elements.filter(e => e.id !== tableId),
    });
    setActiveKey(activeKey.filter(k => k !== tableId));
  };

  const handleUpdateTable = (tableId: string, updates: Partial<TableElementConfig>) => {
    onChange({
      ...config,
      elements: config.elements.map(e =>
        e.id === tableId ? { ...e, ...updates } : e
      ),
    });
  };

  const handleAddColumn = (tableId: string) => {
    const table = config.elements.find(e => e.id === tableId);
    if (!table) return;

    const newColumn: TableColumnConfig = {
      id: `col-${Date.now()}`,
      name: `Column ${table.columns.length + 1}`,
      dataKey: `field${table.columns.length + 1}`,
      sortable: true,
      filterable: false,
      render: 'text',
    };

    handleUpdateTable(tableId, {
      columns: [...table.columns, newColumn],
    });
  };

  const handleUpdateColumn = (tableId: string, columnId: string, updates: Partial<TableColumnConfig>) => {
    const table = config.elements.find(e => e.id === tableId);
    if (!table) return;

    handleUpdateTable(tableId, {
      columns: table.columns.map(c =>
        c.id === columnId ? { ...c, ...updates } : c
      ),
    });
  };

  const handleDeleteColumn = (tableId: string, columnId: string) => {
    const table = config.elements.find(e => e.id === tableId);
    if (!table) return;

    handleUpdateTable(tableId, {
      columns: table.columns.filter(c => c.id !== columnId),
    });
  };

  const handleSave = () => {
    onClose();
  };

  return (
    <div className="widget-config-panel">
      {/* Global Settings */}
      <div className="config-section">
        <div className="config-section-title">
          <TableOutlined className="config-section-title-icon" />
          Global Settings
        </div>
        <Form layout="vertical">
          <Form.Item label="Default View">
            <Select
              placeholder="Select default table"
              value={config.defaultView}
              onChange={(value) => onChange({ ...config, defaultView: value })}
              allowClear
            >
              {config.elements.map((table) => (
                <Select.Option key={table.id} value={table.id}>
                  {table.name}
                </Select.Option>
              ))}
            </Select>
          </Form.Item>
        </Form>
      </div>

      {/* Tables Configuration */}
      <div className="config-section">
        <div className="config-section-title">
          <TableOutlined className="config-section-title-icon" />
          Tables ({config.elements.length})
        </div>

        {config.elements.length === 0 ? (
          <Empty
            image={Empty.PRESENTED_IMAGE_SIMPLE}
            description="No tables configured"
            className="empty-state"
          >
            <Button type="primary" icon={<PlusOutlined />} onClick={handleAddTable}>
              Add Your First Table
            </Button>
          </Empty>
        ) : (
          <Collapse
            activeKey={activeKey}
            onChange={(keys) => setActiveKey(keys as string[])}
            style={{ marginBottom: 16 }}
          >
            {config.elements.map((table) => (
              <Panel
                key={table.id}
                header={
                  <Space>
                    <TableOutlined />
                    <span style={{ fontWeight: 500 }}>{table.name}</span>
                    <Tag color="blue">{table.columns.length} columns</Tag>
                    {!table.enabled && <Tag color="red">Disabled</Tag>}
                    {table.dataBinding && (
                      <Tag color="green" icon={<LinkOutlined />}>
                        Bound
                      </Tag>
                    )}
                  </Space>
                }
                extra={
                  <Popconfirm
                    title="Delete this table?"
                    onConfirm={(e) => {
                      e?.stopPropagation();
                      handleDeleteTable(table.id);
                    }}
                    onCancel={(e) => e?.stopPropagation()}
                  >
                    <Button
                      type="text"
                      danger
                      size="small"
                      icon={<DeleteOutlined />}
                      onClick={(e) => e.stopPropagation()}
                    />
                  </Popconfirm>
                }
              >
                <Form layout="vertical">
                  <Form.Item label="Table Name">
                    <Input
                      value={table.name}
                      onChange={(e) =>
                        handleUpdateTable(table.id, { name: e.target.value })
                      }
                      placeholder="e.g., Device List"
                    />
                  </Form.Item>

                  {/* Data Binding Section */}
                  <div className="data-binding-section">
                    <div className="data-binding-title">
                      <LinkOutlined />
                      Data Binding
                    </div>
                    <Form.Item label="Data Source">
                      <Select
                        placeholder="Select a data source"
                        value={table.dataBinding?.mockDataKey}
                        onChange={(value) => {
                          const source = tableDataSources.find(s => s.key === value);
                          handleUpdateTable(table.id, {
                            dataBinding: {
                              id: `binding-${Date.now()}`,
                              name: source?.name || 'Data Source',
                              sourceType: source?.type || 'static-data',
                              mockDataKey: value,
                              refreshInterval: 10000,
                            },
                          });
                        }}
                        showSearch
                      >
                        {tableDataSources.map((source) => (
                          <Select.Option key={source.key} value={source.key}>
                            <div>
                              <div style={{ fontWeight: 500 }}>{source.name}</div>
                              <div style={{ fontSize: 12, color: '#8c8c8c' }}>
                                {source.description}
                              </div>
                            </div>
                          </Select.Option>
                        ))}
                      </Select>
                    </Form.Item>
                  </div>

                  {/* Columns Configuration */}
                  <div style={{ marginTop: 24 }}>
                    <div style={{ marginBottom: 12, fontWeight: 600, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                      <span>Columns ({table.columns.length})</span>
                      <Button size="small" icon={<PlusOutlined />} onClick={() => handleAddColumn(table.id)}>
                        Add Column
                      </Button>
                    </div>

                    <AntTable
                      dataSource={table.columns}
                      rowKey="id"
                      pagination={false}
                      size="small"
                      columns={[
                        {
                          title: 'Name',
                          dataIndex: 'name',
                          render: (text, record) => (
                            <Input
                              value={text}
                              size="small"
                              onChange={(e) =>
                                handleUpdateColumn(table.id, record.id, { name: e.target.value })
                              }
                            />
                          ),
                        },
                        {
                          title: 'Data Key',
                          dataIndex: 'dataKey',
                          render: (text, record) => (
                            <Input
                              value={text}
                              size="small"
                              onChange={(e) =>
                                handleUpdateColumn(table.id, record.id, { dataKey: e.target.value })
                              }
                            />
                          ),
                        },
                        {
                          title: 'Render',
                          dataIndex: 'render',
                          render: (text, record) => (
                            <Select
                              value={text}
                              size="small"
                              style={{ width: '100%' }}
                              onChange={(value) =>
                                handleUpdateColumn(table.id, record.id, { render: value })
                              }
                            >
                              {RENDER_TYPES.map(type => (
                                <Select.Option key={type.value} value={type.value}>
                                  {type.label}
                                </Select.Option>
                              ))}
                            </Select>
                          ),
                        },
                        {
                          title: 'Sort',
                          dataIndex: 'sortable',
                          width: 60,
                          render: (checked, record) => (
                            <Switch
                              size="small"
                              checked={checked}
                              onChange={(value) =>
                                handleUpdateColumn(table.id, record.id, { sortable: value })
                              }
                            />
                          ),
                        },
                        {
                          title: 'Action',
                          width: 60,
                          render: (_, record) => (
                            <Popconfirm
                              title="Delete column?"
                              onConfirm={() => handleDeleteColumn(table.id, record.id)}
                            >
                              <Button
                                type="text"
                                danger
                                size="small"
                                icon={<DeleteOutlined />}
                              />
                            </Popconfirm>
                          ),
                        },
                      ]}
                    />
                  </div>

                  {/* Table Settings */}
                  <div style={{ marginTop: 16 }}>
                    <Space orientation="vertical" style={{ width: '100%' }}>
                      <Space style={{ width: '100%', justifyContent: 'space-between' }}>
                        <Form.Item label="Page Size" style={{ marginBottom: 0, flex: 1 }}>
                          <InputNumber
                            min={5}
                            max={100}
                            value={table.pageSize}
                            onChange={(value) =>
                              handleUpdateTable(table.id, { pageSize: value || 10 })
                            }
                            style={{ width: '100%' }}
                          />
                        </Form.Item>
                      </Space>

                      <Space style={{ width: '100%', justifyContent: 'space-between' }}>
                        <Form.Item label="Show Pagination" style={{ marginBottom: 0 }}>
                          <Switch
                            checked={table.showPagination}
                            onChange={(checked) =>
                              handleUpdateTable(table.id, { showPagination: checked })
                            }
                          />
                        </Form.Item>

                        <Form.Item label="Show Search" style={{ marginBottom: 0 }}>
                          <Switch
                            checked={table.showSearch}
                            onChange={(checked) =>
                              handleUpdateTable(table.id, { showSearch: checked })
                            }
                          />
                        </Form.Item>

                        <Form.Item label="Exportable" style={{ marginBottom: 0 }}>
                          <Switch
                            checked={table.exportable}
                            onChange={(checked) =>
                              handleUpdateTable(table.id, { exportable: checked })
                            }
                          />
                        </Form.Item>

                        <Form.Item label="Enabled" style={{ marginBottom: 0 }}>
                          <Switch
                            checked={table.enabled}
                            onChange={(checked) =>
                              handleUpdateTable(table.id, { enabled: checked })
                            }
                          />
                        </Form.Item>
                      </Space>
                    </Space>
                  </div>
                </Form>
              </Panel>
            ))}
          </Collapse>
        )}

        <div className="add-element-button" onClick={handleAddTable}>
          <PlusOutlined />
          Add Table
        </div>
      </div>

      {/* Action Buttons */}
      <div className="config-actions">
        <Button onClick={onClose}>Cancel</Button>
        <Button type="primary" onClick={handleSave}>
          Save Configuration
        </Button>
      </div>
    </div>
  );
}
