/**
 * Chart Widget Configuration Panel
 * Allows users to add/edit multiple charts with data bindings
 */

import { useState } from 'react';
import {
  Button,
  Form,
  Input,
  Select,
  Switch,
  Collapse,
  Space,
  InputNumber,
  Popconfirm,
  Empty,
  Tag,
  ColorPicker,
  Radio,
} from 'antd';
import {
  PlusOutlined,
  DeleteOutlined,
  LineChartOutlined,
  BarChartOutlined,
  AreaChartOutlined,
  PieChartOutlined,
  DashOutlined,
  LinkOutlined,
} from '@ant-design/icons';
import type { ChartWidgetConfig, ChartElementConfig } from '../../types/ConfigurableWidget.types';
import { getDataSourcesByType } from '../../data/mockDataSources';
import '../../base/ConfigurableWidget.css';

const { Panel } = Collapse;

interface ChartConfigPanelProps {
  config: ChartWidgetConfig;
  onChange: (newConfig: ChartWidgetConfig) => void;
  onClose: () => void;
}

const CHART_TYPE_ICONS = {
  line: <LineChartOutlined />,
  bar: <BarChartOutlined />,
  area: <AreaChartOutlined />,
  pie: <PieChartOutlined />,
  scatter: <DashOutlined />,
  gauge: <DashOutlined />,
};

export default function ChartConfigPanel({ config, onChange, onClose }: ChartConfigPanelProps) {
  const [activeKey, setActiveKey] = useState<string[]>([]);

  // Ensure config has default values
  const safeConfig: ChartWidgetConfig = {
    elements: config?.elements || [],
    layout: config?.layout || 'grid',
    gridColumns: config?.gridColumns || 2,
    height: config?.height || 300,
    timeRange: config?.timeRange || '24h',
  };

  // Get time-series data sources for charts
  const timeSeriesDataSources = getDataSourcesByType('historical-timeseries');
  const allCompatibleDataSources = [
    ...timeSeriesDataSources,
    ...getDataSourcesByType('realtime-sensor'),
    ...getDataSourcesByType('aggregated-metrics'),
  ];

  const handleAddChart = () => {
    const newChart: ChartElementConfig = {
      id: `chart-${Date.now()}`,
      name: `Chart ${safeConfig.elements.length + 1}`,
      enabled: true,
      displayOrder: safeConfig.elements.length,
      type: 'chart',
      chartType: 'line',
      showLegend: true,
      showGrid: true,
      color: '#1890ff',
    };

    onChange({
      ...safeConfig,
      elements: [...safeConfig.elements, newChart],
    });
    setActiveKey([...activeKey, newChart.id]);
  };

  const handleDeleteChart = (chartId: string) => {
    onChange({
      ...safeConfig,
      elements: safeConfig.elements.filter(e => e.id !== chartId),
    });
    setActiveKey(activeKey.filter(k => k !== chartId));
  };

  const handleUpdateChart = (chartId: string, updates: Partial<ChartElementConfig>) => {
    onChange({
      ...safeConfig,
      elements: safeConfig.elements.map(e =>
        e.id === chartId ? { ...e, ...updates } : e
      ),
    });
  };

  const handleUpdateGlobalSettings = (updates: Partial<ChartWidgetConfig>) => {
    onChange({ ...safeConfig, ...updates });
  };

  const handleSave = () => {
    onClose();
  };

  return (
    <div className="widget-config-panel">
      {/* Global Settings */}
      <div className="config-section">
        <div className="config-section-title">
          <LineChartOutlined className="config-section-title-icon" />
          Global Settings
        </div>
        <Form layout="vertical">
          <Form.Item label="Layout Mode">
            <Radio.Group
              value={safeConfig.layout}
              onChange={(e) => handleUpdateGlobalSettings({ layout: e.target.value })}
            >
              <Radio value="grid">Grid</Radio>
              <Radio value="tabs">Tabs</Radio>
              <Radio value="carousel">Carousel</Radio>
            </Radio.Group>
          </Form.Item>

          {safeConfig.layout === 'grid' && (
            <Form.Item label="Grid Columns">
              <InputNumber
                min={1}
                max={3}
                value={safeConfig.gridColumns}
                onChange={(value) => handleUpdateGlobalSettings({ gridColumns: value || 2 })}
                style={{ width: '100%' }}
              />
            </Form.Item>
          )}

          <Form.Item label="Chart Height (px)">
            <InputNumber
              min={200}
              max={800}
              step={50}
              value={safeConfig.height}
              onChange={(value) => handleUpdateGlobalSettings({ height: value || 300 })}
              style={{ width: '100%' }}
            />
          </Form.Item>

          <Form.Item label="Time Range">
            <Select
              value={safeConfig.timeRange}
              onChange={(value) => handleUpdateGlobalSettings({ timeRange: value })}
            >
              <Select.Option value="1h">Last Hour</Select.Option>
              <Select.Option value="24h">Last 24 Hours</Select.Option>
              <Select.Option value="7d">Last 7 Days</Select.Option>
              <Select.Option value="30d">Last 30 Days</Select.Option>
            </Select>
          </Form.Item>
        </Form>
      </div>

      {/* Charts Configuration */}
      <div className="config-section">
        <div className="config-section-title">
          <BarChartOutlined className="config-section-title-icon" />
          Charts ({safeConfig.elements.length})
        </div>

        {safeConfig.elements.length === 0 ? (
          <Empty
            image={Empty.PRESENTED_IMAGE_SIMPLE}
            description="No charts configured"
            className="empty-state"
          >
            <Button type="primary" icon={<PlusOutlined />} onClick={handleAddChart}>
              Add Your First Chart
            </Button>
          </Empty>
        ) : (
          <Collapse
            activeKey={activeKey}
            onChange={(keys) => setActiveKey(keys as string[])}
            style={{ marginBottom: 16 }}
          >
            {safeConfig.elements.map((chart) => (
              <Panel
                key={chart.id}
                header={
                  <Space>
                    {CHART_TYPE_ICONS[chart.chartType]}
                    <span style={{ fontWeight: 500 }}>{chart.name}</span>
                    {!chart.enabled && <Tag color="red">Disabled</Tag>}
                    {chart.dataBinding && (
                      <Tag color="green" icon={<LinkOutlined />}>
                        Bound
                      </Tag>
                    )}
                  </Space>
                }
                extra={
                  <Popconfirm
                    title="Delete this chart?"
                    onConfirm={(e) => {
                      e?.stopPropagation();
                      handleDeleteChart(chart.id);
                    }}
                    onCancel={(e) => e?.stopPropagation()}
                  >
                    <Button
                      type="text"
                      danger
                      size="small"
                      icon={<DeleteOutlined />}
                      onClick={(e) => e.stopPropagation()}
                    />
                  </Popconfirm>
                }
              >
                <Form layout="vertical">
                  <Form.Item label="Chart Name">
                    <Input
                      value={chart.name}
                      onChange={(e) =>
                        handleUpdateChart(chart.id, { name: e.target.value })
                      }
                      placeholder="e.g., Temperature Trends"
                    />
                  </Form.Item>

                  <Form.Item label="Chart Type">
                    <Select
                      value={chart.chartType}
                      onChange={(value) => handleUpdateChart(chart.id, { chartType: value })}
                    >
                      <Select.Option value="line">
                        <LineChartOutlined /> Line Chart
                      </Select.Option>
                      <Select.Option value="bar">
                        <BarChartOutlined /> Bar Chart
                      </Select.Option>
                      <Select.Option value="area">
                        <AreaChartOutlined /> Area Chart
                      </Select.Option>
                      <Select.Option value="pie">
                        <PieChartOutlined /> Pie Chart
                      </Select.Option>
                      <Select.Option value="scatter">Scatter Plot</Select.Option>
                      <Select.Option value="gauge">Gauge</Select.Option>
                    </Select>
                  </Form.Item>

                  <Form.Item label="Chart Color">
                    <ColorPicker
                      value={chart.color}
                      onChange={(_, hex) => handleUpdateChart(chart.id, { color: hex })}
                      showText
                    />
                  </Form.Item>

                  {/* Data Binding Section */}
                  <div className="data-binding-section">
                    <div className="data-binding-title">
                      <LinkOutlined />
                      Data Binding
                    </div>
                    <Form.Item label="Data Source">
                      <Select
                        placeholder="Select a data source"
                        value={chart.dataBinding?.mockDataKey}
                        onChange={(value) => {
                          const source = allCompatibleDataSources.find(s => s.key === value);
                          handleUpdateChart(chart.id, {
                            dataBinding: {
                              id: `binding-${Date.now()}`,
                              name: source?.name || 'Data Source',
                              sourceType: source?.type || 'historical-timeseries',
                              mockDataKey: value,
                              refreshInterval: 5000,
                            },
                          });
                        }}
                        showSearch
                      >
                        {allCompatibleDataSources.map((source) => (
                          <Select.Option key={source.key} value={source.key}>
                            <div>
                              <div style={{ fontWeight: 500 }}>{source.name}</div>
                              <div style={{ fontSize: 12, color: '#8c8c8c' }}>
                                {source.description}
                              </div>
                            </div>
                          </Select.Option>
                        ))}
                      </Select>
                    </Form.Item>
                  </div>

                  <Form.Item label="X-Axis Label" style={{ marginTop: 16 }}>
                    <Input
                      value={chart.xAxisLabel}
                      onChange={(e) =>
                        handleUpdateChart(chart.id, { xAxisLabel: e.target.value })
                      }
                      placeholder="e.g., Time"
                    />
                  </Form.Item>

                  <Form.Item label="Y-Axis Label">
                    <Input
                      value={chart.yAxisLabel}
                      onChange={(e) =>
                        handleUpdateChart(chart.id, { yAxisLabel: e.target.value })
                      }
                      placeholder="e.g., Value"
                    />
                  </Form.Item>

                  <Space style={{ width: '100%', justifyContent: 'space-between' }}>
                    <Form.Item label="Show Legend" style={{ marginBottom: 0 }}>
                      <Switch
                        checked={chart.showLegend}
                        onChange={(checked) =>
                          handleUpdateChart(chart.id, { showLegend: checked })
                        }
                      />
                    </Form.Item>

                    <Form.Item label="Show Grid" style={{ marginBottom: 0 }}>
                      <Switch
                        checked={chart.showGrid}
                        onChange={(checked) =>
                          handleUpdateChart(chart.id, { showGrid: checked })
                        }
                      />
                    </Form.Item>

                    <Form.Item label="Enabled" style={{ marginBottom: 0 }}>
                      <Switch
                        checked={chart.enabled}
                        onChange={(checked) =>
                          handleUpdateChart(chart.id, { enabled: checked })
                        }
                      />
                    </Form.Item>
                  </Space>
                </Form>
              </Panel>
            ))}
          </Collapse>
        )}

        <div className="add-element-button" onClick={handleAddChart}>
          <PlusOutlined />
          Add Chart
        </div>
      </div>

      {/* Action Buttons */}
      <div className="config-actions">
        <Button onClick={onClose}>Cancel</Button>
        <Button type="primary" onClick={handleSave}>
          Save Configuration
        </Button>
      </div>
    </div>
  );
}
